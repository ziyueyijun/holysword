# HolySword 路由使用指南

本文档详细介绍 HolySword 框架的路由功能和使用方法。

## 路由基础

HolySword 框架的路由定义在 `routes/` 目录下：

- `routes/api.php` - API 路由（自动添加 `/api` 前缀）
- `routes/web.php` - Web 路由（无前缀）

## 定义路由

### 基本路由

```php
// GET 请求
$router->get('/users', function () {
    return Response::success(['message' => 'GET users']);
});

// POST 请求
$router->post('/users', function () {
    return Response::success(['message' => 'POST users']);
});

// PUT 请求
$router->put('/users/{id}', function ($id) {
    return Response::success(['message' => "PUT user {$id}"]);
});

// DELETE 请求
$router->delete('/users/{id}', function ($id) {
    return Response::success(['message' => "DELETE user {$id}"]);
});

// PATCH 请求
$router->patch('/users/{id}', function ($id) {
    return Response::success(['message' => "PATCH user {$id}"]);
});
```

### 控制器路由

```php
use App\Controllers\UserController;

// 单个路由
$router->get('/users', [UserController::class, 'index']);
$router->get('/users/{id}', [UserController::class, 'show']);
$router->post('/users', [UserController::class, 'store']);
$router->put('/users/{id}', [UserController::class, 'update']);
$router->delete('/users/{id}', [UserController::class, 'destroy']);
```

## 路由参数

### 必选参数

```php
// 单个参数
$router->get('/users/{id}', function ($id) {
    return Response::success(['user_id' => $id]);
});

// 多个参数
$router->get('/posts/{postId}/comments/{commentId}', function ($postId, $commentId) {
    return Response::success([
        'post_id' => $postId,
        'comment_id' => $commentId
    ]);
});
```

### 控制器中获取参数

```php
class UserController extends Controller
{
    public function show($id)
    {
        $user = User::find($id);
        return Response::success($user);
    }
    
    public function update($id)
    {
        // 获取路由参数 $id
        // 获取请求参数
        $data = request()->all();
        
        $user = User::find($id);
        $user->update($data);
        
        return Response::success($user);
    }
}
```

## 路由分组

### 基本分组

```php
// 添加前缀
$router->group(['prefix' => 'admin'], function ($router) {
    $router->get('/users', [AdminController::class, 'users']);
    $router->get('/settings', [AdminController::class, 'settings']);
});

// 生成的路由：
// GET /api/admin/users
// GET /api/admin/settings
```

### 嵌套分组

```php
$router->group(['prefix' => 'v1'], function ($router) {
    
    $router->group(['prefix' => 'users'], function ($router) {
        $router->get('/', [UserController::class, 'index']);
        $router->get('/{id}', [UserController::class, 'show']);
    });
    
    $router->group(['prefix' => 'posts'], function ($router) {
        $router->get('/', [PostController::class, 'index']);
        $router->get('/{id}', [PostController::class, 'show']);
    });
});

// 生成的路由：
// GET /api/v1/users
// GET /api/v1/users/{id}
// GET /api/v1/posts
// GET /api/v1/posts/{id}
```

## 中间件

### 定义中间件

```php
// app/Middleware/AuthMiddleware.php

namespace App\Middleware;

use HolySword\Http\Request;
use HolySword\Http\Response;
use HolySword\Middleware\MiddlewareInterface;

class AuthMiddleware implements MiddlewareInterface
{
    public function handle(Request $request, callable $next): Response
    {
        // 检查认证
        $token = $request->header('Authorization');
        
        if (!$token) {
            return Response::error('未授权访问', 401);
        }
        
        // 验证 token...
        
        // 继续执行下一个中间件或控制器
        return $next($request);
    }
}
```

### 应用中间件

```php
use App\Middleware\AuthMiddleware;

// 单个路由应用中间件
$router->get('/profile', [UserController::class, 'profile'])
       ->middleware(AuthMiddleware::class);

// 路由分组应用中间件
$router->group(['middleware' => AuthMiddleware::class], function ($router) {
    $router->get('/profile', [UserController::class, 'profile']);
    $router->post('/settings', [UserController::class, 'updateSettings']);
});
```

## 请求处理

### 获取请求数据

```php
class UserController extends Controller
{
    public function store()
    {
        // 获取所有输入
        $all = request()->all();
        
        // 获取单个输入
        $name = request()->input('name');
        $email = request()->input('email', 'default@example.com');
        
        // 获取 JSON 数据
        $data = request()->json();
        
        // 获取查询参数
        $page = request()->query('page', 1);
        $limit = request()->query('limit', 10);
        
        // 获取请求头
        $token = request()->header('Authorization');
        $contentType = request()->header('Content-Type');
        
        // 获取请求方法
        $method = request()->method();
        
        // 获取请求路径
        $path = request()->path();
        
        return Response::success($all);
    }
}
```

### 验证请求数据

```php
class UserController extends Controller
{
    public function store()
    {
        $data = request()->all();
        
        // 使用验证器
        $validator = validator($data, [
            'name' => 'required|min:2|max:50',
            'email' => 'required|email',
            'password' => 'required|min:6',
        ]);
        
        if ($validator->fails()) {
            return Response::error($validator->firstError(), 422);
        }
        
        // 验证通过，继续处理
        $user = User::create($data);
        
        return Response::success($user);
    }
}
```

## 响应处理

### 返回 JSON 响应

```php
// 成功响应
return Response::success($data);
return Response::success($data, '操作成功');

// 错误响应
return Response::error('操作失败');
return Response::error('未找到资源', 404);
return Response::error('服务器错误', 500);

// 自定义 JSON 响应
return Response::json([
    'code' => 0,
    'message' => '自定义消息',
    'data' => $data
]);
```

### 重定向

```php
// 重定向到 URL
return Response::redirect('/login');
return Response::redirect('https://example.com');
```

## RESTful API 示例

完整的 RESTful 控制器示例：

```php
// app/Controllers/ArticleController.php

namespace App\Controllers;

use HolySword\Http\Response;
use App\Models\Article;

class ArticleController extends Controller
{
    /**
     * 获取文章列表
     * GET /api/articles
     */
    public function index()
    {
        $page = request()->query('page', 1);
        $limit = request()->query('limit', 10);
        
        $articles = Article::orderBy('created_at', 'desc')
                          ->limit($limit)
                          ->offset(($page - 1) * $limit)
                          ->get();
        
        $total = Article::count();
        
        return Response::success([
            'list' => $articles,
            'total' => $total,
            'page' => $page,
            'limit' => $limit,
        ]);
    }
    
    /**
     * 获取文章详情
     * GET /api/articles/{id}
     */
    public function show($id)
    {
        $article = Article::find($id);
        
        if (!$article) {
            return Response::error('文章不存在', 404);
        }
        
        return Response::success($article);
    }
    
    /**
     * 创建文章
     * POST /api/articles
     */
    public function store()
    {
        $data = request()->all();
        
        $validator = validator($data, [
            'title' => 'required|max:200',
            'content' => 'required',
        ]);
        
        if ($validator->fails()) {
            return Response::error($validator->firstError(), 422);
        }
        
        $article = Article::create($data);
        
        return Response::success($article, '创建成功');
    }
    
    /**
     * 更新文章
     * PUT /api/articles/{id}
     */
    public function update($id)
    {
        $article = Article::find($id);
        
        if (!$article) {
            return Response::error('文章不存在', 404);
        }
        
        $data = request()->all();
        $article->update($data);
        
        return Response::success($article, '更新成功');
    }
    
    /**
     * 删除文章
     * DELETE /api/articles/{id}
     */
    public function destroy($id)
    {
        $article = Article::find($id);
        
        if (!$article) {
            return Response::error('文章不存在', 404);
        }
        
        $article->delete();
        
        return Response::success(null, '删除成功');
    }
}
```

路由定义：

```php
// routes/api.php

use App\Controllers\ArticleController;

$router->get('/articles', [ArticleController::class, 'index']);
$router->get('/articles/{id}', [ArticleController::class, 'show']);
$router->post('/articles', [ArticleController::class, 'store']);
$router->put('/articles/{id}', [ArticleController::class, 'update']);
$router->delete('/articles/{id}', [ArticleController::class, 'destroy']);
```
