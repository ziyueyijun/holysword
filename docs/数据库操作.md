# HolySword 数据库操作指南

本文档详细介绍 HolySword 框架的数据库操作和 ORM 使用方法。

## 配置数据库

### 环境配置

编辑 `.env` 文件：

```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=holysword
DB_USERNAME=root
DB_PASSWORD=your_password
DB_PREFIX=hs_
DB_CHARSET=utf8mb4
```

### 支持的数据库

- MySQL 5.7+
- PostgreSQL 10+
- SQLite 3
- SQL Server

## 定义模型

### 基本模型

```php
// app/Models/User.php

namespace App\Models;

use HolySword\Database\Model\Model;

class User extends Model
{
    /**
     * 表名（可选，默认使用类名复数形式）
     */
    protected string $table = 'users';
    
    /**
     * 主键（可选，默认 'id'）
     */
    protected string $primaryKey = 'id';
    
    /**
     * 可批量赋值的字段
     */
    protected array $fillable = [
        'name',
        'email',
        'password',
        'status',
    ];
    
    /**
     * 隐藏字段（toArray/toJson 时不显示）
     */
    protected array $hidden = [
        'password',
    ];
    
    /**
     * 自动维护时间戳
     */
    protected bool $timestamps = true;
}
```

### 类型转换

```php
class User extends Model
{
    /**
     * 字段类型转换
     */
    protected array $casts = [
        'id' => 'integer',
        'is_admin' => 'boolean',
        'settings' => 'array',
        'created_at' => 'datetime',
    ];
}
```

## 基本查询

### 获取数据

```php
// 获取所有记录
$users = User::all();

// 获取单条记录
$user = User::find(1);
$user = User::findOrFail(1); // 找不到抛出异常

// 获取第一条记录
$user = User::first();
$user = User::where('status', 1)->first();

// 获取指定条件的记录
$users = User::where('status', 1)->get();
```

### 条件查询

```php
// 等于
$users = User::where('status', 1)->get();
$users = User::where('status', '=', 1)->get();

// 不等于
$users = User::where('status', '!=', 0)->get();
$users = User::where('status', '<>', 0)->get();

// 大于/小于
$users = User::where('age', '>', 18)->get();
$users = User::where('age', '>=', 18)->get();
$users = User::where('age', '<', 60)->get();
$users = User::where('age', '<=', 60)->get();

// LIKE 查询
$users = User::where('name', 'like', '%张%')->get();

// IN 查询
$users = User::whereIn('id', [1, 2, 3])->get();
$users = User::whereNotIn('id', [1, 2, 3])->get();

// NULL 查询
$users = User::whereNull('deleted_at')->get();
$users = User::whereNotNull('email_verified_at')->get();

// BETWEEN 查询
$users = User::whereBetween('age', [18, 60])->get();
```

### 多条件查询

```php
// AND 条件
$users = User::where('status', 1)
             ->where('role', 'admin')
             ->get();

// OR 条件
$users = User::where('status', 1)
             ->orWhere('role', 'admin')
             ->get();

// 复杂条件
$users = User::where('status', 1)
             ->where(function ($query) {
                 $query->where('role', 'admin')
                       ->orWhere('role', 'moderator');
             })
             ->get();
```

### 排序和分页

```php
// 排序
$users = User::orderBy('created_at', 'desc')->get();
$users = User::orderBy('name', 'asc')->get();

// 多字段排序
$users = User::orderBy('status', 'desc')
             ->orderBy('created_at', 'desc')
             ->get();

// 限制数量
$users = User::limit(10)->get();
$users = User::take(10)->get();

// 偏移
$users = User::offset(10)->limit(10)->get();
$users = User::skip(10)->take(10)->get();

// 分页查询
$page = 1;
$limit = 10;
$users = User::orderBy('id', 'desc')
             ->offset(($page - 1) * $limit)
             ->limit($limit)
             ->get();
```

### 聚合查询

```php
// 计数
$count = User::count();
$count = User::where('status', 1)->count();

// 求和
$total = Order::sum('amount');

// 平均值
$avg = Order::avg('amount');

// 最大值/最小值
$max = Order::max('amount');
$min = Order::min('amount');
```

## 新增数据

### 创建记录

```php
// 使用 create 方法
$user = User::create([
    'name' => '张三',
    'email' => 'zhangsan@example.com',
    'password' => password_hash('123456', PASSWORD_DEFAULT),
]);

// 使用 new 和 save
$user = new User();
$user->name = '李四';
$user->email = 'lisi@example.com';
$user->password = password_hash('123456', PASSWORD_DEFAULT);
$user->save();
```

### 批量创建

```php
// 插入多条记录
User::insert([
    ['name' => '用户1', 'email' => 'user1@example.com'],
    ['name' => '用户2', 'email' => 'user2@example.com'],
    ['name' => '用户3', 'email' => 'user3@example.com'],
]);
```

## 更新数据

### 更新单条记录

```php
// 找到并更新
$user = User::find(1);
$user->name = '新名字';
$user->save();

// 使用 update 方法
$user = User::find(1);
$user->update([
    'name' => '新名字',
    'email' => 'new@example.com',
]);
```

### 批量更新

```php
// 更新多条记录
User::where('status', 0)->update(['status' => 1]);

// 更新或创建
$user = User::updateOrCreate(
    ['email' => 'test@example.com'],  // 查询条件
    ['name' => '测试用户', 'status' => 1]  // 更新/创建的数据
);
```

## 删除数据

### 删除记录

```php
// 删除单条记录
$user = User::find(1);
$user->delete();

// 通过主键删除
User::destroy(1);
User::destroy([1, 2, 3]);

// 条件删除
User::where('status', 0)->delete();
```

### 软删除

```php
// 模型中使用软删除
use HolySword\Database\Model\Traits\SoftDeletes;

class User extends Model
{
    use SoftDeletes;
    
    // 软删除字段（默认 deleted_at）
    protected string $deletedAt = 'deleted_at';
}

// 软删除记录
$user = User::find(1);
$user->delete(); // 只是设置 deleted_at，不会真正删除

// 查询包含已删除的记录
$users = User::withTrashed()->get();

// 只查询已删除的记录
$users = User::onlyTrashed()->get();

// 恢复软删除的记录
$user = User::withTrashed()->find(1);
$user->restore();

// 永久删除
$user->forceDelete();
```

## 模型关联

### 一对一

```php
// User 模型
class User extends Model
{
    /**
     * 获取用户的个人资料
     */
    public function profile()
    {
        return $this->hasOne(Profile::class, 'user_id', 'id');
    }
}

// Profile 模型
class Profile extends Model
{
    /**
     * 获取资料所属的用户
     */
    public function user()
    {
        return $this->belongsTo(User::class, 'user_id', 'id');
    }
}

// 使用
$user = User::find(1);
$profile = $user->profile; // 获取用户资料

$profile = Profile::find(1);
$user = $profile->user; // 获取资料所属用户
```

### 一对多

```php
// User 模型
class User extends Model
{
    /**
     * 获取用户的所有文章
     */
    public function posts()
    {
        return $this->hasMany(Post::class, 'user_id', 'id');
    }
}

// Post 模型
class Post extends Model
{
    /**
     * 获取文章的作者
     */
    public function author()
    {
        return $this->belongsTo(User::class, 'user_id', 'id');
    }
}

// 使用
$user = User::find(1);
$posts = $user->posts; // 获取用户的所有文章

$post = Post::find(1);
$author = $post->author; // 获取文章作者
```

### 多对多

```php
// User 模型
class User extends Model
{
    /**
     * 获取用户的所有角色
     */
    public function roles()
    {
        return $this->belongsToMany(
            Role::class,
            'user_roles',  // 中间表
            'user_id',     // 当前模型外键
            'role_id'      // 关联模型外键
        );
    }
}

// Role 模型
class Role extends Model
{
    /**
     * 获取角色的所有用户
     */
    public function users()
    {
        return $this->belongsToMany(
            User::class,
            'user_roles',
            'role_id',
            'user_id'
        );
    }
}

// 使用
$user = User::find(1);
$roles = $user->roles; // 获取用户的所有角色
```

### 预加载

```php
// 避免 N+1 查询问题
$users = User::with('posts')->get();

// 预加载多个关联
$users = User::with(['posts', 'profile'])->get();

// 嵌套预加载
$users = User::with('posts.comments')->get();

// 条件预加载
$users = User::with(['posts' => function ($query) {
    $query->where('status', 1)->orderBy('created_at', 'desc');
}])->get();
```

## 原生 SQL

### 查询构造器

```php
// 使用 DB 类
$users = db()->table('users')->get();
$users = db()->table('users')->where('status', 1)->get();

// 原生查询
$users = db()->select('SELECT * FROM users WHERE status = ?', [1]);

// 原生插入
db()->insert('INSERT INTO users (name, email) VALUES (?, ?)', ['张三', 'test@example.com']);

// 原生更新
db()->update('UPDATE users SET status = ? WHERE id = ?', [1, 1]);

// 原生删除
db()->delete('DELETE FROM users WHERE id = ?', [1]);
```

### 事务处理

```php
// 自动事务
db()->transaction(function () {
    User::create(['name' => '张三', 'email' => 'test@example.com']);
    Profile::create(['user_id' => 1, 'bio' => '个人简介']);
});

// 手动事务
db()->beginTransaction();

try {
    User::create(['name' => '张三', 'email' => 'test@example.com']);
    Profile::create(['user_id' => 1, 'bio' => '个人简介']);
    
    db()->commit();
} catch (\Exception $e) {
    db()->rollBack();
    throw $e;
}
```

## 数据库迁移示例

创建用户表的 SQL：

```sql
-- 用户表
CREATE TABLE `users` (
    `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户ID',
    `name` VARCHAR(50) NOT NULL COMMENT '用户名',
    `email` VARCHAR(100) NOT NULL COMMENT '邮箱',
    `password` VARCHAR(255) NOT NULL COMMENT '密码',
    `status` TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted_at` DATETIME DEFAULT NULL COMMENT '删除时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_email` (`email`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```
