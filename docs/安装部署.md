# HolySword 安装部署指南

本文档详细介绍 HolySword 框架的安装和部署流程，包括 Windows 和 Linux 环境。

## 环境要求

### 必需环境

| 环境 | 最低版本 | 推荐版本 |
|------|----------|----------|
| PHP | 8.1 | 8.2+ |
| MySQL | 5.7 | 8.0+ |
| Composer | 2.0 | 最新版 |

### PHP 扩展要求

- PDO（数据库连接）
- pdo_mysql / pdo_pgsql / pdo_sqlite（根据数据库类型选择）
- mbstring（多字节字符串处理）
- json（JSON 处理）
- openssl（加密功能）

## Linux 部署

### 1. 安装 PHP 8.1+

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install php8.1 php8.1-fpm php8.1-mysql php8.1-mbstring php8.1-xml php8.1-curl

# CentOS/RHEL
sudo yum install epel-release
sudo yum install php81 php81-php-fpm php81-php-mysqlnd php81-php-mbstring
```

### 2. 安装 Composer

```bash
# 下载安装脚本
php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"

# 安装到全局
php composer-setup.php --install-dir=/usr/local/bin --filename=composer

# 验证安装
composer --version
```

### 3. 安装 MySQL

```bash
# Ubuntu/Debian
sudo apt install mysql-server

# CentOS/RHEL
sudo yum install mysql-server
sudo systemctl start mysqld
sudo systemctl enable mysqld
```

### 4. 部署项目

```bash
# 克隆项目
cd /var/www
git clone https://github.com/holysword/framework.git holysword

# 进入目录
cd holysword

# 安装依赖
composer install --no-dev --optimize-autoloader

# 复制配置文件
cp .env.example .env

# 设置目录权限
chmod -R 755 .
chmod -R 777 logs
chown -R www-data:www-data .
```

### 5. 配置 Nginx

创建站点配置文件 `/etc/nginx/sites-available/holysword`：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/holysword/public;
    index index.php;

    # 日志配置
    access_log /var/log/nginx/holysword_access.log;
    error_log /var/log/nginx/holysword_error.log;

    # 字符集
    charset utf-8;

    # 路由重写
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP 处理
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # 超时设置
        fastcgi_read_timeout 300;
    }

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
    }

    # 禁止访问敏感文件
    location ~* \.(env|log|sql)$ {
        deny all;
    }
}
```

启用站点：

```bash
sudo ln -s /etc/nginx/sites-available/holysword /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 6. 配置数据库

```bash
# 登录 MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE holysword CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户（可选）
CREATE USER 'holysword'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON holysword.* TO 'holysword'@'localhost';
FLUSH PRIVILEGES;
```

### 7. 配置环境变量

编辑 `.env` 文件：

```bash
APP_NAME=HolySword
APP_ENV=production
APP_DEBUG=false
APP_URL=https://your-domain.com

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=holysword
DB_USERNAME=holysword
DB_PASSWORD=your_password
```

## Windows 部署

### 1. 安装 XAMPP 或 WNMP

推荐使用 [XAMPP](https://www.apachefriends.org/) 或 [PhpStudy](https://www.xp.cn/)。

### 2. 配置 PHP

确保 `php.ini` 中启用以下扩展：

```ini
extension=pdo_mysql
extension=mbstring
extension=openssl
extension=curl
```

### 3. 安装 Composer

下载 [Composer-Setup.exe](https://getcomposer.org/Composer-Setup.exe) 并运行安装。

### 4. 部署项目

```cmd
# 进入 Web 目录
cd C:\xampp\htdocs

# 克隆项目
git clone https://github.com/holysword/framework.git holysword

# 进入目录
cd holysword

# 安装依赖
composer install

# 复制配置文件
copy .env.example .env
```

### 5. 配置虚拟主机

编辑 `C:\xampp\apache\conf\extra\httpd-vhosts.conf`：

```apache
<VirtualHost *:80>
    DocumentRoot "C:/xampp/htdocs/holysword/public"
    ServerName holysword.local
    
    <Directory "C:/xampp/htdocs/holysword/public">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>
```

编辑 `C:\Windows\System32\drivers\etc\hosts`：

```
127.0.0.1 holysword.local
```

重启 Apache 服务。

## 验证安装

访问以下地址验证安装是否成功：

```
http://your-domain.com/api/status
```

应返回：

```json
{
    "code": 0,
    "message": "success",
    "data": {
        "status": "running",
        "timestamp": 1234567890,
        "app": "HolySword"
    }
}
```

## 常见问题

### 1. 500 Internal Server Error

- 检查 PHP 错误日志
- 确认目录权限正确
- 检查 `.env` 配置是否正确

### 2. 数据库连接失败

- 确认数据库服务已启动
- 检查数据库配置是否正确
- 确认数据库用户权限

### 3. 页面空白

- 启用调试模式：`APP_DEBUG=true`
- 查看 `logs/` 目录下的日志文件

## 生产环境优化

### 1. 启用 OPcache

编辑 `php.ini`：

```ini
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=4000
opcache.revalidate_freq=60
opcache.fast_shutdown=1
```

### 2. Composer 优化

```bash
composer install --no-dev --optimize-autoloader --classmap-authoritative
```

### 3. 配置 HTTPS

建议使用 Let's Encrypt 免费证书：

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```
